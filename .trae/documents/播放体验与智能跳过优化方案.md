## 优化目标概览

- 提升片头/片尾提示的可见性与交互体验，避免与“清晰/网速/质量”元素冲突。
- 强化播放源优选与质量评分，在不同设备与网络下稳定选到最佳源。
- 降低测速与实时指标的性能占用，减少卡顿与电量消耗。
- 优化跳过配置的批量设置与同步，减少用户操作成本。

## 现状快速诊断

- 跳过提示与质量徽章位置重叠，存在遮挡风险（play/page.tsx:4870 质量徽章；SkipController.tsx:854 提示）。
- 片头/片尾检测已包含冷却、防重复与“剩余时间”模式，但切集瞬间与临时配置闭包可能导致边缘重复触发（src/components/SkipController.tsx:345-481）。
- 质量评分权重固定（分辨率 40%/速度 40%/延迟 20%），在移动端与弱网下可能不够鲁棒（src/app/play/page.tsx:1020-1085）。
- 移动端轻量测速仅 ping，桌面并发测速存在批次延迟与失败回退逻辑（src/app/play/page.tsx:818-933, 963）。
- 指标面板实时采集带宽估计、缓冲秒数、丢帧（src/app/play/page.tsx:4927-4951），采样与刷新间隔未统一节流策略。

## 优化方向与实施步骤

### 1. UI 层级与布局

- 统一将跳过提示与质量徽章设定明确层级与间距，避免互相遮挡：
  - 在 `src/components/SkipController.tsx:854` 和 `src/app/play/page.tsx:4870-4898` 区域，设定跳过提示高于徽章的层级，质量面板不覆盖提示。
  - 增加可配置的提示位置选项（左上/右上/下方），减少与“?”按钮、徽章同列的冲突。

### 2. 片头/片尾检测鲁棒性

- 明确 episode 切换冷却与“已处理片段”标记的生命周期：
  - 审核并保持 `lastProcessedSegmentRef` 与 `episodeSwitchCooldownRef` 的重置时机（src/components/SkipController.tsx:782-800）。
  - 在 `checkSkipSegment` 中对临时 segments 使用去重策略并校验 duration 边界（src/components/SkipController.tsx:355-414, 420-481）。
- 增加“片尾结束为空直接下一集”的边界校验，避免负值或溢出（src/components/SkipController.tsx:598-639）。

### 3. 播放源优选与评分策略

- 针对设备与网络动态调整权重：
  - 移动端与弱网将“延迟”提升到 30%，桌面维持现有权重（src/app/play/page.tsx:1020-1085）。
  - 对分辨率缺失或同高不同码率的情况，加入码率次级评分与最小可用层级保障（src/app/play/page.tsx:3106-3140）。
- 失败回退优化：
  - 扩展失败源的记录与跳过策略，避免反复选择已失败源（src/app/play/page.tsx:919-934, 963）。

### 4. 测速与并发控制

- 移动端维持“仅 ping”轻量策略，桌面端限制并发并统一超时与批次间隔（src/app/play/page.tsx:818-933）。
- 将测速结果缓存并复用到 `EpisodeSelector`，避免重复测速（src/app/play/page.tsx:289 备注，结合组件调用）。

### 5. 实时指标与节流

- 为带宽估计、缓冲秒数、丢帧采集设定统一的采样窗口与刷新频率（如 500ms-1000ms 节流），降低 UI 抖动与 CPU 开销（src/app/play/page.tsx:4927-4951, 4521-4522）。
- 指标面板在非可见时停止采集，进入可见再恢复，减少后台开销。

### 6. 跳过配置批量设置与同步

- 保持全局开关与批量设置的 localStorage 同步广播（src/components/SkipController.tsx:901-945），补充输入格式校验与错误提示（src/components/SkipController.tsx:575-665）。
- 服务端接口对 `remaining` 模式进行统一解析，避免客户端 duration 差异导致的片尾偏移（src/app/api/episode-skip-config/route.ts 与 db.client 类型对齐）。

### 7. 可访问性与国际化

- 为按钮与提示增加键盘可达与 ARIA 标签；提示条支持 Enter 触发跳过。
- 清晰的多语言文案支持，质量面板与跳过提示统一术语。

### 8. 后续能力：场景检测（非必需，作为增强）

- 预研简单的黑帧+静音+片尾片段识别，作为“智能建议”，仍以用户确认为准，避免误跳。

## 验证与度量

- UI：确保提示不被遮挡，位置切换无重叠；移动/桌面均可用。
- 检测：切集后 3 秒冷却有效，片头/片尾不重复触发；剩余时间模式在不同 duration 下定位正确。
- 优选：在 4K/1080p/弱网三种场景下选源时间与成功率提升；失败源不被再次选中。
- 指标：面板打开时刷新稳定，无明显抖动；面板关闭时采集停用，CPU 占用下降。

## 风险与回退

- 权重调整可能短期影响选择习惯；提供“恢复默认”与“设备自适应”选项作为回退。
- 节流过度会降低实时性；通过开关与阈值可调保障体验。

## 里程碑与优先级

- M1（UI 与鲁棒性）：完成层级/位置与检测防重复、冷却优化。
- M2（优选与测速）：完成权重自适应、并发与缓存策略。
- M3（指标与可用性）：完成节流采样、ARIA 与国际化；预研场景检测。
